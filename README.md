# Freedom QR Reader Android SDK

[![](https://jitpack.io/v/freedompay-global/freedom-qr-reader-android-sdk.svg)](https://jitpack.io/#freedompay-global/freedom-qr-reader-android-sdk)

Freedom QR Reader - SDK для сканирования QR кода клиента, а так же взаимодействия с API Freedom Pay.

- [Предварительные этапы](#предварительные-этапы)
- [Требования](#требования)
- [Подключение](#подключение)
- [Интеграция](#интеграция)
  - [Начало](#начало)
  - [Инициализация запросов](#инициализация-запросов)
  - [Информация об ошибке](#информация-об-ошибке)
  - [UI](#ui)
    - [View для добавления карты](#view-для-добавления-карты)
    - [View для сканирования QR кода мерчанта](#view-для-сканирования-qr-кода-мерчанта)
  - [Основные методы SDK](#основные-методы-sdk)
    - [Получение списка токенизированных карт](#получение-списка-токенизированных-карт)
    - [Добавление токенизированной карты](#добавление-токенизированной-карты)
    - [Удаление токенизированный карты](#удаление-токенизированный-карты)
    - [Получение статуса по счёту](#получение-статуса-по-счёту)
    - [Оплата счёта с помощью токенизированной карты](#оплата-счёта-с-помощью-токенизированной-карты)
- [Поддержка](#поддержка)


## Предварительные этапы

Для начала работы с QR client SDK в качестве партнера заполните заявку на
подключение мерчанта.
После создания и подключения мерчанта в личном кабинете вы получите
`Merchant_ID` и `Secret_key` которые необходимы для взаимодействия с SDK.

## Требования
Для работы QR client SDK необходим Android версии 5.0 (API level 24).


## Подключение
Для подключения SDK добавьте в `build.gradle` вашего корневогого проекта следующую строчку:

```groovy
allprojects {
    repositories {
        maven { url 'https://jitpack.io' }
    }
}
```

Так же добавьте в `build.gradle` вашего проекта следующую строчку:

```groovy
dependencies {
    implementation "implementation 'com.github.freedompay-global:freedom-qr-reader-android-sdk:${version}"
}
```
`version` - текущая версия SDK.


## Интеграция


### Начало

Всё необходимое взаимодействие в библиотеке происходит только через класс `FreedomQrClient`.
Для инициализации SDK в вашем фрагменте или активити необходимо создать объект:
```kotlin 
private val sdk = FreedomQrClient.initialize(secretKey, merchantId)
```

`secretKey: String` - секретный ключ, который выдается при подключения мерчанта в личном кабинете.

`merchanId: String` - уникальный идентификатор, который присваивается мерчанту после создания аккаунта.


### Инициализация запросов

После создания объекта SDK, необходимо ознакомиться с основной структурой параметров для инициализации запросов, состоящая из
`params` и `callbacks`.

```kotlin
sdkObject.methodName("params",
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```
- `sdkObject` - объект SDK, который был проинициализирован


- `methodName` - название метода, который был вызван пользователем


### Параметры запросов

| Параметр    | Описание                                                                                         |
|-------------|--------------------------------------------------------------------------------------------------|
| `params`    | Один или несколько параметров, которые необходимо передать пользователю для совершения запроса   |
| `onResult`  | Возвращает объект выполнения запроса `<T>`                                                       |
| `onError`   | Возвращает объект `ErrorResponse`, который позволяет получить информацию об ошибке               |
| `onFailure` | Возвращает объект  `Exception`, который позволяет получить информацию об ошибке отправки запроса |


### Информация об ошибке
Объект который позволяет получить информацию об ошибке с сервера:

| Поле        | Описание                                                                                            |
|-------------|-----------------------------------------------------------------------------------------------------|
| `code`      | Код, возвращаемой ошибки с сервера. С основными кодами ошибок можно ознакомиться в [документации]() |
| `message`   | Сообщение об ошибке                                                                                 |


## Пример работы с SDK


## UI

### View для добавления карты

Для добавления токенизированной карты в систему Freedom Pay необходимо использовать кастомную view `AddCardView`,
которую нужно добавить в ваш XML файл фрагмента или активити. `AddCardView` представляет собой webview, на которой будет открываться страница добавления карты.

Пример добавления `AddCardView`:

```xml
    <money.freedompay.qrclient.api.ui.AddCardView
        android:id="@+id/addCardView"
        android:layout_width="match_parent"
        android:layout_height="match_parent"/>
```

После добавления в xml, необходимо передать вашу view в SDK:
```kotlin
  sdk.setCardView(addCardView)
```
Для отслеживания прогресса загрузки или возвращаемого результата привязки карты доступен публичный интерфейс `AddCardViewListener`,
который необходимо переопределить в вашем фрагменте или активити и передать в вашу view `AddCardView`:
```kotlin
  addCardView.setListener(this)
```

`this` - это интерфейс `AddCardViewListener`, который имеет следующие методы

Начало загрузки страницы добавления карты:
```kotlin
    override fun onLoadStarted() {
        // переопределите начало загрузки
    }
```

Конец загрузки страницы добавления карты:
```kotlin
    override fun onLoadStarted() {
        // переопределите конец загрузки
    }
```

Результат добавления карты:
```kotlin
    override fun onResult(isSuccess: Boolean) {
        // переопределите результат добавления карты
    }
```

`isSuccess` - означает успешность результата добавления карты

### View для сканирования QR кода мерчанта

Для сканирования QR кода мерчанта Freedom Pay и осуществления после оплаты счёта необходимо использовать кастомную view `FreedomQRScannerView`,
которую нужно добавить в ваш XML файл фрагмента или активити. `FreedomQRScannerView` представляет собой экран с камерой для осуществления сканирования QR кода.

Пример добавления `FreedomQRScannerView`:
```xml
<money.freedompay.qrclient.api.ui.FreedomQRScannerView
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    app:isVibrationAfterScanning="true"/>
```

Успешное сканирование QR кода сопровождается сигналом в виде вибрации и контролируется специальным аттрибутом `isVibrationAfterScanning`

| Результат | Описание                 |
|-----------|--------------------------|
| `true`    | Вибросигнал присутствует |
| `false`   | Вибросигнал отсутсвует   |

Для контроля состояния камеры такие как включение и отключение необходимо в вашем фрагменте или активити добавить соответствующие методы

Включение камеры:
```kotlin
    override fun onResume() {
        super.onResume()
        freedomQrScannerView.startCamera()
    }
```

Отключение камеры:
```kotlin
    override fun onPause() {
        super.onPause()
        freedomQrScannerView.stopCamera()
    }
```

Для отслеживания состояния успешности сканировния QR кода или возвращаемого результата доступны публичные интерфейсы `ResultHandler` и `ErrorHandler`.

`ResultHandler` - публичный интерфейс, который возвращает результат сканировния QR кода. Для использования метода необходимо переопределить в вашем фрагменте или активити.

```kotlin
  freedomQrScannerView.setResultHandler(this)
```

`this` - это интерфейс `ResultHandler`, который имеет следующий метод

```kotlin
  override fun handleResult(result: String) {
      // переопределите результат сканировния
  }
```
- `result: String` результат сканирования QR кода


`ErrorHandler` - публичный интерфейс, который возвращает callback ошибки, который вы сами можете переопределить на своё усмотрение.
Для использования метода необходимо переопределить в вашем фрагменте или активити

```kotlin
  freedomQrScannerView.setErrorHandler(this)
```

`this` - это интерфейс `ErrorHandler`, который имеет следующий метод

```kotlin
  override fun errorResult() {
      // переопределите ошибку
  }
```

Примечание:
 - Для корректной работы с view сканированием QR кода необходимо в вашем фрагменте или активити разрешить доступ к `android.permission.CAMERA`
 - Результатом сканирования QR кода является поле `customerId`, которое необходимо для получения [статуса по счёту](#получение-статуса-по-счёту) или [оплаты счёта](#оплата-счёта-с-помощью-токенизированной-карты)


## Основные методы SDK


### Получение списка токенизированных карт
Для получения списка токенизированных карт необходимо вызвать метод `sdk.getTokenizedCardList`. 

В метод также необходимо передать следующие параметры: 
- `userId: String` - уникальный идентификатор пользователя в системе мерчанта.

Пример вызова метода для получения списка токенизированных карт:
```kotlin
sdk.getTokenizedCardList("userId",
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```
В результате успешного вызова метода получения списка токенизированных карт в callback `onResult` вернется объект `TokenizedCardResponse`, 
содержащий список карт:

| Поле                                     | Описание                     |
|------------------------------------------|------------------------------|
| `List<TokenizedCardDetailResponse> list` | Список токенизированных карт | 

Список карт представляет собой список объектов класса `TokenizedCardDetailResponse`, содержащий следующие поля:

| Поле        | Описание                       |
|-------------|--------------------------------|
| `status`    | Показывает статус карты        | 
| `cardToken` | Уникальный идентификатор карты | 
| `cardHash`  | Маскированный PAN карты        | 

Примечание:
- Если ни одна токенизированная карта не была добавлена в систему Freedom Pay
то в качестве ответа от сервера также придет `TokenizedCardResponse`, где список карт будет пустым

### Добавление токенизированной карты

Добавление токенизированной карты в систему Freedom Pay осуществляется на странице [добавления карты](#view-для-добавления-карты).
После того как ваша view `AddCardView` была передана  в SDK, необходимо вызвать метод `sdk.initAddingCard`.

В метод также необходимо передать следующие параметры:
- `userId: String` уникальный идентификатор пользователя в системе мерчанта.


- `postLink: String` - необязательное поле, представляет собой URL для сообщения о результате.

Пример вызова метода для добавления токенизированной карты:

```kotlin
sdk.initAddingCard("userId", "postLink",
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```

В результате успешного вызова метода инициализации добавления токенизированной карты `AddCardView`
в webView откроет страницу добавления карты, на которой необходимо ввести карточные данные для добавления карты.

После успешного заполнения карточных данных, нужно подтвердить данные заполнения и отправить данные.

Примечание:
- В методе инициализации добавления карты `sdk.initAddingCard` нету callback `onResult`, потому что результат добавления карты можно отследить в методе интерфейса [AddCardViewListener](#view-для-добавления-карты).

Результат добавления карты:

| Результат | Описание                  |
|-----------|---------------------------|
| `true`    | Карта успешно добавлена   |
| `false`   | Не удалось добавить карту |

### Удаление токенизированный карты
Для удаления токенизированной карты необходимо вызвать метод `sdk.removeTokenizedCard`.

В метод также необходимо передать следующие параметры:
- `userId: String` - уникальный идентификатор пользователя в системе мерчанта.
- `tokenCard: String` - уникальный идентификатор карты, который можно получить в запросе на получение [списка карт](#получение-списка-токенизированных-карт)

Пример вызова метода для удаления токенизированной карты:
```kotlin
sdk.removeTokenizedCard("userId", "cardToken",
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```
В результате успешного вызова метода удаления токенизированной карты в callback `onResult` так же как и 
при получении списка карт вернется объект [TokenizedCardResponse](#получение-списка-токенизированных-карт) в котором поменяется поле статуса карты `status`


### Получение статуса по счёту

Для получения статуса по счёту на оплату необходимо вызвать метод `sdk.getPaymentStatus`

В метод также необходимо передать следующие параметры:
- `customerId: String` - уникальный идентификатор который отображается при инициализации оплаты с помощью генерации QR кода и который можно получить при [считывании QR кода](#view-для-сканирования-qr-кода-мерчанта) мерчанта

Пример вызова метода для получения статуса по счёту:
```kotlin
sdk.getPaymentStatus("customerId",
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```
В результате успешного вызова метода получения статуса по счёту в callback `onResult` вернется объект `PaymentStatusResponse`,
содержащий следующие поля:

| Поле            | Описание                                                   |
|-----------------|------------------------------------------------------------|
| `amount`        | Сумма счёта на оплату в валюте поля `currency`             |
| `orderId`       | Идентификатор счёта в системе мерчанта                     |
| `invoiceStatus` | Статус счёта                                               |
| `invoiceId`     | Уникальный идентификатор счёта в систему Freedom Pay       |
| `cardPan`       | Маскированный пан карты                                    |
| `description`   | Описание товара или услуги                                 |
| `currency`      | Валюта в которой будет проводиться оплата                  |
| `dt`            | Дата и время запроса в формате `YYYY-MM-DDThh:mm:ss±hh:mm` |

Примечание:
- Статус счёта `invoiceStatus` может иметь разные состояния: 

| Значение     | Описание                                   |
|--------------|--------------------------------------------|
| `new`        | Создан новый счёт                          |
| `process`    | Ожидание плательщика или платежной системы |
| `ok`         | Счёт успешно оплачен                       |
| `failed`     | Ошибка оплаты счёта                        |
| `incomplete` | Истекло время жизни счёта                  |


### Оплата счёта с помощью токенизированной карты

Для оплаты счёта с помощью токенизированноый карты необходимо [отсканировать QR код](#view-для-сканирования-qr-кода-мерчанта) мерчанта
из которого вы получить поле `customerId`, необходимое для совершения оплаты, а также вызвать метод `sdk.payByCard`

В метод также необходимо передать следующие параметры:
- `customerId: String` - уникальный идентификатор который отображается при инициализации оплаты с помощью генерации QR кода и который можно получить при считывании QR кода мерчанта
- `userId: String` - уникальный идентификатор пользователя в системе мерчанта.
- `tokenCard: String` - уникальный идентификатор карты, который можно получить в запросе на получение [списка карт](#получение-списка-токенизированных-карт)

Примечание:
- Если у вас нету ни одной добавленной токенизированной карты в системе Freedom Pay, сперва необходимо будет добавить карту. Сделать это можно в методе [добавления карты](#добавление-токенизированной-карты)

Пример вызова метода для оплаты счёта
```kotlin
sdk.getPaymentStatus("customerId", "userId", "tokenCard",
    onResult = { result ->
        // результат выполнения запроса
    },
    onError = { serverError ->
        // ошибка с сервера
    },
    onFailure = { exception ->
        // ошибка отправки запроса
    }
)
```

В результате успешного вызова метода оплаты счёта с помощью токенизированной карты в callback `onResult` 
вернется тот же самый объект, что и при получении статуса счёта [PaymentStatusResponse](#получение-статуса-по-счёту)

Примечание:
- Основным отличием модели `PaymentStatusResponse` является только то, что поле `invoiceStatus` поменяет статус счёта.


## Поддержка

- По возникающим вопросам просьба обращаться на [support@freedompay.money](mailto:support@freedompay.money)
